{% extends 'system/base.html' %}

{% block header %}
<script>

function load_filters() {
    show_throbber('#filter-table-body');
    
    var API_URL = BASE_URL + 'api/filter/read';

    $.getJSON(API_URL, function(d) {
        var tbody = $('#filter-table-body');
        tbody.empty();
        
        $.each(d.filters, function(i, filter) {
            var tr = get_tr_for_filter(filter);
            tr.appendTo(tbody);
        });

        if (d.filters.length == 0) {
            tbody.append('<tr><td colspan="999"><center>No filters are currently active.</center></td></tr>');
        }

        hide_throbber('#filter-table-body');
    });
}

function add_filter() {
    var API_URL = BASE_URL + 'api/filter/create';
    var name = $('#filter_name').val();
    var atoms = {};

    $('form.atoms').each(function(d) {
        if($(this).find('.enable').is('checked'));

        var k = {};
        var j = $(this).serializeArray();

        $.each(j, function(i, n) {
            k[n, name] = n.value;
        });
    });

    $.getJSON(API_URL, {atoms:atoms, 'name':name}, function(d) {
        if(d.error) {
            alert("Error: Failed to add new filter.");
            alert(d.error);
        } else {
            alert(d.success)
        }
    });
}

function get_tr_for_filter(filter) {
    var tr = $('<tr>', {'data-index': filter.name});
    var checkbox = $('<input>', {type: 'checkbox',
                                 class: 'filter-select-toggle',
                                 'data-index': filter.name});
    $('<td>', {html: checkbox}).appendTo(tr);
    $('<td>', {text: filter.name}).appendTo(tr);
    $('<td>', {text: filter.action}).appendTo(tr);

    return tr;
}

$(document).ready(function() {

    load_filters();

    $('#add_new_filter').click(function() {
        add_filter();
    });

    $('#toggle').click(function() {
        var checkboxes = $('.filter-select-toggle');
        checkboxes.attr('checked', !checkboxes.attr('checked'));
    });

    $('.delete-selected').click(function() {
        var API_URL = BASE_URL + 'api/filter/delete';
        
        $('.filter-select-toggle:checked').each(function() {
            var data = {name : $(this).attr('data-index')};
            $.getJSON(API_URL, data, function(data) {
                if(data.error) {
                    alert(data.error);
                } else {
                    $(this).parent().parent().remove();
                }
            })
        })
    });
})
</script>
{% endblock header %}

{% block content %}
<div class='row container content'>
    <div class="col-md-6">
        <button type="button" class="btn btn-primary btn-lg add-filter" data-toggle="modal" data-target="#add_filter_modal">Add New Filter</button>
    </div>
    <div class="col-md-6"></div>
</div>

<div id='filter-content' class='row container content'>
    <div class='panel panel-default'>
        <div class='panel-heading' id='pagination-summary'></div>
        <div id='pagination' class='panel-body text-center'></div>
        <div class='pull-left'>
            <div class='btn-group btn-group-sm trap-controllers'>
                <button type='button' class='btn btn-default btn-delete'>
                    <a alt='Delete Selected' data-toggle='tooltip' title='Delete Selected' class='delete-selected glyphicon glyphicon-remove'></a>
                </button>
            </div>
        </div>
        <table id='filter-table' class='table table-condensed table-striped table-hover table-bordered'>
            <thead id='filter-table-head'>
                <tr>
                    <th class='text-center toggle-checkbox'><input type="checkbox" id="toggle"></th>
                    <th class='text-center'>Name</th>
                    <th class='text-center'>Description</th>
                </tr>
            </thead>
            <tfoot id='filter-table-foot'>
                <tr>
                    <td colspan='999'>
                        <div class='pull-left'>
                            <div class='btn-group btn-group-sm trap-controllers'>
                                <button type='button' class='btn btn-default btn-delete'>
                                    <a alt='Delete Selected' data-toggle='tooltip' title='Delete Selected' class='delete-selected glyphicon glyphicon-remove'></a>
                                </button>
                            </div>
                        </div>
                    </td>
                </tr>
            </tfoot>
            <tbody id='filter-table-body'>
            </tbody>
        </table>
    </div>
</div>

<div class='modal fade' id='error-message' tabindex='-1' role='dialog' aria-labelledby='error-message-label' aria-hidden='true'>
    <div class='modal-dialog'>
        <div class='modal-content'>
            <div class='modal-header'>
                <button type='button' class='close' data-dismiss='modal' aria-hidden='true'>&times;</button>
                <h4 class='modal-title'>Error Handling Request</h4>
            </div>
            <div id='modal-body-error' class='modal-body'></div>
            <div class='modal-footer'>
                <button type='button' class='btn btn-primary' data-dismiss='modal'>Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="add_filter_modal" hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">Create A New Filter</h4>
      </div>
      <div class="modal-body">
        <form>
            <table>
                <td valign="top">
                    <label>New Filter Name:</label>
                    <input type="text" class="form-control" id="filter_name" placeholder="New Filter"><br><br>
                </td>
            </table>
        </form>

        <h4 class="modal-title">Filters</h4><br>
            <form class="atoms form-inline" role="form">
                <div class="row">
                    <div class="checkbox col-xs-3">
                        <label class="checkbox-inline">
                            <input type="checkbox" name="enable">
                            Date:
                        </label>
                    </div>
                    <br>
                    <div class="form-group">
                        <input name="column_name" value="date" type="hidden">
                    </div>
                    <div class="form-group col-xs-3">
                        <select name="comparison" class="form-control">
                            <option>none</option>
                            <option>></option>
                            <option><</option>
                            <option>=</option>
                            <option>>=</option>
                            <option><=</option>
                        </select>
                    </div>
                    <div class="form-group col-xs-5">
                        <input name="val" class="form-control" placeholder="MM/DD/YY">
                    </div>
                </div>
            </form>

            <form class="atoms form-inline" role="form">
                <div class="row">
                    <div class="checkbox col-xs-3">
                        <label class="checkbox-inline">
                            <input type="checkbox" name="enable">
                            Trap OID:
                        </label>
                    </div>
                    <br>
                    <div class="form-group">
                        <input name="column_name" value="trapoid" type="hidden">
                    </div>
                    <div class="form-group col-xs-3">
                        <select name="comparison" class="form-control">
                            <option>none</option>
                            <option>></option>
                            <option><</option>
                            <option>=</option>
                            <option>>=</option>
                            <option><=</option>
                        </select>
                    </div>
                    <div class="form-group col-xs-5">
                        <input name="val" class="form-control" placeholder="1.1.1.1.1.1.1.1.1">
                    </div>
                </div>
            </form>

            <form class="atoms form-inline" role="form">
                <div class="row">
                    <div class="checkbox col-xs-3">
                        <label class="checkbox-inline">
                            <input type="checkbox" name="enable">
                            Enterprise OID:
                        </label>
                    </div>
                    <br>
                    <div class="form-group">
                        <input name="column_name" value="enterpriseoid" type="hidden">
                    </div>
                    <div class="form-group col-xs-3">
                        <select name="comparison" class="form-control">
                            <option>none</option>
                            <option>></option>
                            <option><</option>
                            <option>=</option>
                            <option>>=</option>
                            <option><=</option>
                        </select>
                    </div>
                    <div class="form-group col-xs-5">
                        <input name="val" class="form-control" placeholder="1.1.1.1.1.1.1.1.1">
                    </div>
                </div>
            </form>
            
            <form class="atoms form-inline" role="form">
                <div class="row">
                    <div class="checkbox col-xs-3">
                        <label class="checkbox-inline">
                            <input type="checkbox" name="enable">
                            Hostname:
                        </label>
                    </div>
                    <br>
                    <div class="form-group">
                        <input name="column_name" value="hostname" type="hidden">
                    </div>
                    <div class="form-group col-xs-3">
                        <select name="comparison" class="form-control">
                            <option>none</option>
                            <option>></option>
                            <option><</option>
                            <option>=</option>
                            <option>>=</option>
                            <option><=</option>
                        </select>
                    </div>
                    <div class="form-group col-xs-5">
                        <input name="val" class="form-control" placeholder="192.168.1.1">
                    </div>
                </div>
            </form>

            <form class="atoms form-inline" role="form">
                <div class="row">
                    <div class="checkbox col-xs-3">
                        <label class="checkbox-inline">
                            <input type="checkbox" name="enable">
                            Category:
                        </label>
                    </div>
                    <br>
                    <div class="form-group">
                        <input name="column_name" value="category" type="hidden">
                    </div>
                    <div class="form-group col-xs-3">
                        <select name="comparison" class="form-control">
                            <option>none</option>
                            <option>></option>
                            <option><</option>
                            <option>=</option>
                            <option>>=</option>
                            <option><=</option>
                        </select>
                    </div>
                    <div class="form-group col-xs-5">
                        <input name="val" class="form-control" placeholder="Status Event">
                    </div>
                </div>
            </form>           
                      
            <form class="atoms form-inline" role="form">
                <div class="row">
                    <div class="checkbox col-xs-3">
                        <label class="checkbox-inline">
                            <input type="checkbox" name="enable">
                            Severity:
                        </label>
                    </div>
                    <br>
                    <div class="form-group">
                        <input name="column_name" value="severity" type="hidden">
                    </div>
                    <div class="form-group col-xs-3">
                        <select name="comparison" class="form-control">
                            <option>none</option>
                            <option>></option>
                            <option><</option>
                            <option>=</option>
                            <option>>=</option>
                            <option><=</option>
                        </select>
                    </div>
                    <div class="form-group col-xs-5">
                        <input name="val" class="form-control" placeholder="OK, Warning..">
                    </div>
                </div>
            </form>   
            
            <form class="atoms form-inline" role="form">
                <div class="row">
                    <div class="checkbox col-xs-3">
                        <label class="checkbox-inline">
                            <input type="checkbox" name="enable">
                            Up Time:
                        </label>
                    </div>
                    <br>
                    <div class="form-group">
                        <input name="column_name" value="uptime" type="hidden">
                    </div>
                    <div class="form-group col-xs-3">
                        <select name="comparison" class="form-control">
                            <option>none</option>
                            <option>></option>
                            <option><</option>
                            <option>=</option>
                            <option>>=</option>
                            <option><=</option>
                        </select>
                    </div>
                    <div class="form-group col-xs-5">
                        <input name="val" class="form-control" placeholder="minutes">
                    </div>
                </div>
            </form>

            <form class="atoms form-inline" role="form">
                <div class="row">
                    <div class="checkbox col-xs-3">
                        <label class="checkbox-inline">
                            <input type="checkbox" name="enable">
                            Trap Time:
                        </label>
                    </div>
                    <br>
                    <div class="form-group">
                        <input name="column_name" value="traptime" type="hidden">
                    </div>
                    <div class="form-group col-xs-3">
                        <select name="comparison" class="form-control">
                            <option>none</option>
                            <option>></option>
                            <option><</option>
                            <option>=</option>
                            <option>>=</option>
                            <option><=</option>
                        </select>
                    </div>
                    <div class="form-group col-xs-5">
                        <input name="val" class="form-control" placeholder="minutes">
                    </div>
                </div>
            </form>
        </div>
          <div class="modal-footer">
            <button type="reset" class="btn btn-default" data-reset="modal">Reset</button>
            <button type="submit" class="btn btn-primary" id="add_new_filter">Add New Filter</button>
          </div>
        </div>
    </div>
</div>
{% endblock content %}